<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tic-Tac-Toe Online Pro</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      text-align: center;
      color: white;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      margin-bottom: 5px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    #score {
      font-size: 1.2em;
      margin: 10px 0 20px;
      padding: 5px 15px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 5px;
    }
    #controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .btn, #difficulty-select {
      padding: 10px 15px;
      font-size: 1em;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      background: #34495e; /* Darker blue-grey */
      color: white;
      transition: background 0.3s, transform 0.1s;
    }
    .btn:hover, #difficulty-select:hover {
      background: #4e6d8d;
      transform: translateY(-2px);
    }
    #muteBtn {
      background: #c0392b; /* Red */
    }
    #board {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      gap: 10px;
      justify-content: center;
      margin: 20px auto;
      background: rgba(255, 255, 255, 0.1);
      padding: 10px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    .cell {
      width: 100px;
      height: 100px;
      background: #ecf0f1; /* Light grey */
      color: #333;
      font-size: 3em;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.2s, color 0.2s;
    }
    .cell:hover {
      background: #bdc3c7;
    }
    .cell.win {
      background: #2ecc71; /* Green */
      color: white;
      animation: flashWin 0.5s 3;
    }
    @keyframes flashWin {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    /* --- Chat Styling --- */
    #chat-container {
        width: 320px;
        margin-top: 30px;
        background: rgba(0, 0, 0, 0.2);
        padding: 15px;
        border-radius: 10px;
        display: none; /* Initially hidden */
    }
    #chat-messages {
        height: 150px;
        overflow-y: auto;
        margin-bottom: 10px;
        padding: 10px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: rgba(0, 0, 0, 0.1);
        border-radius: 5px;
        text-align: left;
        font-size: 0.9em;
    }
    #chat-input-container {
        display: flex;
        gap: 5px;
    }
    #chat-input {
        flex-grow: 1;
        padding: 8px;
        border-radius: 5px;
        border: none;
    }
    #send-btn {
        padding: 8px 12px;
        background: #3498db;
    }
    footer {
      margin-top: auto;
      padding-top: 20px;
      font-size: 0.9em;
      color: #ccc;
    }
  </style>
</head>
<body>
  <h1>Tic-Tac-Toe Online Pro</h1>
  <div id="score">X: 0 | O: 0 | Draws: 0</div>

  <div id="controls">
    <select id="difficulty-select">
      <option value="easy">Easy AI</option>
      <option value="normal">Normal AI</option>
      <option value="hard">Hard AI</option>
    </select>
    <button class="btn" onclick="startGame('ai')">Play vs AI</button>
    <button class="btn" onclick="startGame('local')">Two Players (Local)</button>
    <button class="btn" onclick="startGame('online')">Online Multiplayer</button>
    <button class="btn" id="muteBtn" onclick="toggleMusic()">ðŸ”Š Mute</button>
    <button class="btn" onclick="clearScores()">Clear Scores</button>
  </div>
  
  <div id="board"></div>

  <div id="chat-container">
    <h2>Online Chat</h2>
    <div id="chat-messages"></div>
    <div id="chat-input-container">
        <input type="text" id="chat-input" placeholder="Type message..." maxlength="100" disabled>
        <button class="btn" id="send-btn" onclick="sendMessage()" disabled>Send</button>
    </div>
  </div>

  <footer>Developed by Seb-Creations</footer>

  <audio id="bgMusic" loop>
    <source src="https://opengameart.org/sites/default/files/Happy%20Ukulele%20Background%20Music.mp3" type="audio/mpeg" />
  </audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    
    // --- FIREBASE CONFIGURATION ---
    const firebaseConfig = {
      apiKey: "AIzaSyAFUoT40IjaiqH2791QvyNUP6SakHarupY",
      authDomain: "tic-tac-toe-9e69d.firebaseapp.com",
      databaseURL: "https://tic-tac-toe-9e69d-default-rtdb.firebaseio.com/",
      projectId: "tic-tac-toe-9e69d",
      storageBucket: "tic-tac-toe-9e69d.appspot.com",
      messagingSenderId: "279666476240",
      appId: "1:279666476240:web:106c4481fbda677424cad5",
      measurementId: "G-WQV8NJN397"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- DOM REFERENCES ---
    const boardEl = document.getElementById('board');
    const scoreEl = document.getElementById('score');
    const bgMusic = document.getElementById('bgMusic');
    const difficultySelect = document.getElementById('difficulty-select');
    const chatContainer = document.getElementById('chat-container');
    const chatMessagesEl = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');

    // --- GLOBAL GAME STATE ---
    let currentPlayer = 'X';
    let board = Array(9).fill('');
    let mode = 'local';
    let difficulty = 'normal';
    let score = { X: 0, O: 0, draw: 0 };
    let gameActive = true;
    let gameRef = null; // Firebase reference for the current game
    let playerSymbol = null; // 'X' or 'O' for online mode
    let muted = false;

    // --- CORE GAME FUNCTIONS ---

    function drawBoard() {
      boardEl.innerHTML = '';
      board.forEach((cell, i) => {
        const div = document.createElement('div');
        div.className = 'cell';
        div.innerText = cell;
        div.onclick = () => handleMove(i);
        boardEl.appendChild(div);
      });
      scoreEl.textContent = `X: ${score.X} | O: ${score.O} | Draws: ${score.draw}`;
    }

    function handleMove(index) {
      if (!gameActive || board[index]) return;

      // Online check: Only allow move if it is your turn and your symbol
      if (mode === 'online' && currentPlayer !== playerSymbol) {
        alert("It's not your turn!");
        return;
      }
      
      board[index] = currentPlayer;
      
      const win = checkWin();
      if (win) {
        endGame(currentPlayer, win);
      } else if (board.every(cell => cell !== '')) {
        endGame('draw');
      } else {
        currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
        updateBoard();

        if (mode === 'ai' && currentPlayer === 'O') {
          setTimeout(aiMove, 500);
        }
      }
    }

    function endGame(winner, winCombo = null) {
        gameActive = false;
        if (winner === 'draw') {
            score.draw++;
            alert("Draw!");
        } else {
            score[winner]++;
            alert(`Player ${winner} wins!`);
            // Apply win class to winning cells
            if (winCombo) {
                winCombo.forEach(i => {
                    document.querySelectorAll('.cell')[i].classList.add('win');
                });
            }
        }
        
        // Update score display and Firebase
        updateBoard(); 
        
        // Wait a moment then reset the board only, preserving the score
        setTimeout(resetBoard, 2000); 
    }

    function checkWin() {
      const wins = [
        [0,1,2], [3,4,5], [6,7,8],
        [0,3,6], [1,4,7], [2,5,8],
        [0,4,8], [2,4,6]
      ];
      const combo = wins.find(combo => {
        const [a,b,c] = combo;
        return board[a] && board[a] === board[b] && board[a] === board[c];
      });
      return combo || null;
    }

    function resetBoard() {
      board = Array(9).fill('');
      currentPlayer = 'X';
      gameActive = true;
      drawBoard();
    }

    // --- AI LOGIC (WITH DIFFICULTY) ---

    function aiMove() {
      let empty = board.map((v, i) => v === '' ? i : null).filter(v => v !== null);
      if (empty.length === 0) return;

      let move;
      difficulty = difficultySelect.value;
      
      if (difficulty === 'easy') {
        // Easy: Always random move
        move = empty[Math.floor(Math.random() * empty.length)];
      } else if (difficulty === 'normal') {
        // Normal: 50% chance to block/win, 50% random
        if (Math.random() < 0.5) {
             move = findBestMove(true); // Try to find a winning move or block
        }
        if (!move) {
             move = empty[Math.floor(Math.random() * empty.length)];
        }
      } else if (difficulty === 'hard') {
        // Hard: Minimax placeholder (always finds the best available move)
        move = findBestMove(false);
        if (!move) {
             move = empty[Math.floor(Math.random() * empty.length)];
        }
      }
      
      // Execute the move
      setTimeout(() => handleMove(move), 500);
    }
    
    // Simple look-ahead function for Normal/Hard AI
    function findBestMove(isNormal) {
        const opponent = currentPlayer === 'X' ? 'O' : 'X';
        const empty = board.map((v, i) => v === '' ? i : null).filter(v => v !== null);

        // 1. Check for a winning move for AI (O)
        for (let i of empty) {
            board[i] = 'O';
            if (checkWin()) {
                board[i] = ''; return i;
            }
            board[i] = '';
        }
        
        // 2. Check for a block (Player X's winning move)
        for (let i of empty) {
            board[i] = 'X';
            if (checkWin()) {
                board[i] = ''; return i;
            }
            board[i] = '';
        }
        
        // 3. (Hard only) Check center or corners (Simplified best move logic)
        if (!isNormal) {
            if (board[4] === '') return 4; // Center
            for (let i of [0, 2, 6, 8]) {
                if (board[i] === '') return i; // Corners
            }
        }

        return null;
    }

    // --- FIREBASE ONLINE FUNCTIONS ---

    function startGame(selectedMode) {
      mode = selectedMode;
      difficultySelect.style.display = (mode === 'ai' ? 'inline-block' : 'none');
      chatContainer.style.display = (mode === 'online' ? 'block' : 'none');
      
      resetBoard();
      
      if (mode === 'online') {
        // Simple game setup (creates/joins 'game1')
        gameRef = ref(db, 'games/game1');
        
        // Check if game already exists
        onValue(gameRef, (snapshot) => {
            const data = snapshot.val();
            if (data && data.board) {
                // Game exists, player joins as 'O'
                playerSymbol = 'O';
                alert("Joined game as O! It is X's turn.");
            } else {
                // Game does not exist, player starts as 'X'
                playerSymbol = 'X';
                // Initialize game state on Firebase
                set(gameRef, { 
                    board: board, 
                    currentPlayer: 'X',
                    score: score,
                    chat: [] // Initialize chat log
                });
                alert("Game created. You are X. Share the URL!");
            }
            
            // Listen for changes from the server
            onValue(gameRef, handleFirebaseUpdate);
        }, { onlyOnce: true }); // Stop listening after the initial check

        // Enable chat
        chatInput.disabled = false;
        sendBtn.disabled = false;
        onValue(ref(db, 'games/game1/chat'), handleChatUpdate);

      } else {
        gameRef = null;
        playerSymbol = null;
        // Disable chat for local modes
        chatInput.disabled = true;
        sendBtn.disabled = true;
      }
    }
    
    function handleFirebaseUpdate(snapshot) {
        const data = snapshot.val();
        if (data) {
            board = data.board || Array(9).fill('');
            currentPlayer = data.currentPlayer || 'X';
            score = data.score || { X: 0, O: 0, draw: 0 };
            drawBoard();
            if (!gameActive) {
                // Re-evaluate win/draw to show end game screen if necessary
                const win = checkWin();
                if (win) endGame(currentPlayer === 'X' ? 'O' : 'X', win); // Opponent won
                else if (board.every(cell => cell !== '')) endGame('draw');
            }
        }
    }

    function updateBoard() {
      drawBoard();
      if (mode === 'online' && gameRef) {
        // Send updated board, current player, and score to Firebase
        set(gameRef, { board: board, currentPlayer: currentPlayer, score: score, chat: null });
      }
    }
    
    // --- CHAT FUNCTIONS ---
    
    function sendMessage() {
        const text = chatInput.value.trim();
        if (text === "") return;

        const chatRef = ref(db, 'games/game1/chat');
        push(chatRef, {
            sender: playerSymbol,
            message: text,
            timestamp: Date.now()
        });
        chatInput.value = '';
    }
    
    function handleChatUpdate(snapshot) {
        const messages = snapshot.val();
        chatMessagesEl.innerHTML = '';
        if (messages) {
            // Convert messages object to array and sort by timestamp
            const messageList = Object.values(messages).sort((a, b) => a.timestamp - b.timestamp);
            
            messageList.forEach(msg => {
                const p = document.createElement('p');
                const senderColor = msg.sender === 'X' ? 'color: #ffcc00;' : 'color: #3498db;';
                p.innerHTML = `<strong style="${senderColor}">${msg.sender}:</strong> ${msg.message}`;
                chatMessagesEl.appendChild(p);
            });
            // Scroll to bottom
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        }
    }

    // --- MISC / CONTROLS ---

    function toggleMusic() {
        muted = !muted;
        const btn = document.getElementById('muteBtn');
        if (muted) {
            bgMusic.pause();
            btn.innerHTML = 'ðŸ”‡ Unmute';
        } else {
            // Attempt play, relies on user interaction
            bgMusic.play().catch(e => console.log('Music play failed:', e));
            btn.innerHTML = 'ðŸ”Š Mute';
        }
    }
    
    function clearScores() {
        score = { X: 0, O: 0, draw: 0 };
        updateBoard();
        alert("Scores cleared!");
    }

    // Expose functions globally for HTML buttons
    window.startGame = startGame;
    window.handleMove = handleMove;
    window.toggleMusic = toggleMusic;
    window.clearScores = clearScores;
    window.sendMessage = sendMessage;

    // Initial setup
    window.onload = () => {
      drawBoard();
      bgMusic.play().catch(e => console.log('Autoplay blocked. Click mute/unmute to start music.'));
      difficultySelect.style.display = 'none'; // Hide difficulty initially
    };
  </script>
</body>
</html>
