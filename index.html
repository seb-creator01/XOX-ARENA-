<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tic-Tac-Toe by Seb-Creations</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    margin: 0;
    padding: 20px;
  }
  h1 {
    margin-bottom: 5px;
  }
  #board {
    display: grid;
    grid-template-columns: repeat(3, 100px);
    grid-gap: 10px;
    margin: 20px 0;
  }
  .cell {
    width: 100px;
    height: 100px;
    background: rgba(255,255,255,0.2);
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 48px;
    font-weight: bold;
    cursor: pointer;
    border-radius: 10px;
    transition: background 0.3s;
  }
  .cell:hover {
    background: rgba(255,255,255,0.4);
  }
  .disabled {
    pointer-events: none;
    opacity: 0.6;
  }
  #status {
    margin: 10px 0;
    font-size: 1.2rem;
    min-height: 24px;
  }
  #scoreboard {
    margin: 10px 0 30px;
    font-size: 1rem;
  }
  #controls {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
    flex-wrap: wrap;
    justify-content: center;
  }
  select, button {
    padding: 10px 15px;
    font-size: 1rem;
    border-radius: 8px;
    border: none;
    cursor: pointer;
  }
  button {
    background: #2575fc;
    color: white;
    transition: background 0.3s;
  }
  button:hover {
    background: #6a11cb;
  }
  #mute-btn {
    background: #444;
  }
  footer {
    margin-top: auto;
    font-size: 0.9rem;
    color: #ddd;
  }
  #link-section {
    margin: 15px 0;
    font-size: 0.9rem;
    word-break: break-word;
    background: rgba(255,255,255,0.2);
    padding: 10px;
    border-radius: 10px;
    max-width: 320px;
    text-align: center;
  }
</style>
</head>
<body>

<h1>Tic-Tac-Toe</h1>
<div id="status">Loading...</div>

<div id="controls">
  <select id="mode-select" title="Select Mode">
    <option value="single">Play vs AI</option>
    <option value="online">Play Online</option>
  </select>
  <select id="difficulty-select" title="AI Difficulty (only for AI mode)">
    <option value="easy">Easy</option>
    <option value="normal" selected>Normal</option>
    <option value="hard">Hard</option>
  </select>
  <button id="reset-btn">Reset Game</button>
  <button id="mute-btn">ðŸ”Š Mute</button>
</div>

<div id="board"></div>

<div id="scoreboard">
  <div>Player X Wins: <span id="x-wins">0</span></div>
  <div>Player O Wins: <span id="o-wins">0</span></div>
  <div>Draws: <span id="draws">0</span></div>
</div>

<div id="link-section" style="display:none;">
  Share this link to play online:<br />
  <a href="#" target="_blank" id="game-link"></a>
</div>

<footer>Developed by Seb-Creations</footer>

<audio id="bg-music" loop>
  <source src="https://cdn.pixabay.com/download/audio/2022/03/18/audio_b51a469505.mp3?filename=happy-ukulele-4585.mp3" type="audio/mpeg" />
</audio>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAFUoT40IjaiqH2791QvyNUP6SakHarupY",
    authDomain: "tic-tac-toe-9e69d.firebaseapp.com",
    databaseURL: "https://tic-tac-toe-9e69d-default-rtdb.firebaseio.com",
    projectId: "tic-tac-toe-9e69d",
    storageBucket: "tic-tac-toe-9e69d.appspot.com",
    messagingSenderId: "279666476240",
    appId: "1:279666476240:web:106c4481fbda677424cad5"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Game vars
  const boardEl = document.getElementById('board');
  const statusEl = document.getElementById('status');
  const xWinsEl = document.getElementById('x-wins');
  const oWinsEl = document.getElementById('o-wins');
  const drawsEl = document.getElementById('draws');
  const resetBtn = document.getElementById('reset-btn');
  const modeSelect = document.getElementById('mode-select');
  const difficultySelect = document.getElementById('difficulty-select');
  const linkSection = document.getElementById('link-section');
  const gameLink = document.getElementById('game-link');
  const muteBtn = document.getElementById('mute-btn');
  const bgMusic = document.getElementById('bg-music');

  let board = ["", "", "", "", "", "", "", "", ""];
  let currentPlayer = "X";
  let gameActive = true;
  let scores = { X: 0, O: 0, draw: 0 };
  let isOnline = false;
  let gameId = null;
  let playerSymbol = null; // 'X' or 'O' for online mode
  let difficulty = 'normal';
  let muted = false;

  // Winning combos
  const winningCombos = [
    [0,1,2],[3,4,5],[6,7,8],
    [0,3,6],[1,4,7],[2,5,8],
    [0,4,8],[2,4,6]
  ];

  // --- Core Game Logic Functions ---

  // Create board UI
  function createBoard() {
    boardEl.innerHTML = '';
    for(let i=0; i<9; i++) {
      const cell = document.createElement('div');
      cell.classList.add('cell');
      cell.dataset.index = i;
      cell.addEventListener('click', () => handleCellClick(i));
      boardEl.appendChild(cell);
    }
    // Initial display update
    updateBoardUI();
    updateStatus(`Player ${currentPlayer}'s turn`);
  }

  // Update board UI
  function updateBoardUI() {
    const cells = boardEl.querySelectorAll('.cell');
    for(let i=0; i<9; i++) {
      cells[i].textContent = board[i];
      // Disable cell if already occupied or game is inactive
      cells[i].classList.toggle('disabled', board[i] !== "" || !gameActive || (isOnline && currentPlayer !== playerSymbol));
    }
  }

  // Check win
  function checkWin(player) {
    return winningCombos.some(combo =>
      combo.every(index => board[index] === player)
    );
  }

  // Check draw
  function checkDraw() {
    return board.every(cell => cell !== "");
  }

  // Switch player
  function switchPlayer() {
    currentPlayer = currentPlayer === "X" ? "O" : "X";
  }

  // Update status text
  function updateStatus(text) {
    statusEl.textContent = text;
  }

  // Update scoreboard UI
  function updateScores() {
    xWinsEl.textContent = scores.X;
    oWinsEl.textContent = scores.O;
    drawsEl.textContent = scores.draw;
  }

  // Handle game end
  function handleGameEnd(winner) {
    gameActive = false;
    if (winner) {
      scores[winner]++;
      updateStatus(`Player ${winner} Wins! ðŸ¥³`);
    } else {
      scores.draw++;
      updateStatus(`It's a Draw! ðŸ¤`);
    }
    updateScores();
    updateBoardUI(); // To disable all cells
  }

  // Reset game locally
  function resetGameLocal() {
    board.fill("");
    gameActive = true;
    currentPlayer = "X";
    updateBoardUI();
    updateStatus(`Player ${currentPlayer}'s turn`);
    // Stop listening if previously online
    if (gameId && isOnline) {
      db.ref('games/' + gameId).off();
      gameId = null;
      playerSymbol = null;
    }
    isOnline = false;
    linkSection.style.display = 'none';
    difficultySelect.disabled = false;
    modeSelect.value = 'single';
  }

  // --- AI Logic (Minimax for Hard) ---

  // Minimax algorithm
  function minimax(newBoard, player) {
    const availSpots = newBoard.map((v, i) => v === "" ? i : -1).filter(i => i !== -1);
    const opponent = player === 'X' ? 'O' : 'X';

    if (checkWin(opponent)) return { score: -10 };
    if (checkWin(player)) return { score: 10 };
    if (availSpots.length === 0) return { score: 0 };

    const moves = [];
    for (let i = 0; i < availSpots.length; i++) {
      const move = {};
      move.index = availSpots[i];
      newBoard[availSpots[i]] = player;

      if (player === 'O') { // AI (Minimizing Player)
        const result = minimax(newBoard, 'X');
        move.score = result.score;
      } else { // Human (Maximizing Player)
        const result = minimax(newBoard, 'O');
        move.score = result.score;
      }
      newBoard[availSpots[i]] = ""; // Reset spot
      moves.push(move);
    }

    let bestMove;
    if (player === 'O') { // AI is O (Minimizer)
      let bestScore = Infinity;
      for (let i = 0; i < moves.length; i++) {
        if (moves[i].score < bestScore) {
          bestScore = moves[i].score;
          bestMove = i;
        }
      }
    } else { // Human is X (Maximizer)
      let bestScore = -Infinity;
      for (let i = 0; i < moves.length; i++) {
        if (moves[i].score > bestScore) {
          bestScore = moves[i].score;
          bestMove = i;
        }
      }
    }
    return moves[bestMove];
  }

  // AI move logic (easy, normal, hard)
  function aiMove() {
    if (!gameActive || isOnline) return;
    const emptyIndices = board.map((v,i) => v === "" ? i : -1).filter(i => i !== -1);
    if (emptyIndices.length === 0) return;

    let moveIndex;

    if (difficulty === 'easy') {
      // Random move
      moveIndex = emptyIndices[Math.floor(Math.random() * emptyIndices.length)];

    } else if (difficulty === 'normal') {
      // Block win, then try to win, otherwise random
      const ai = 'O';
      const human = 'X';

      // 1. Check for immediate win
      for (let i of emptyIndices) {
        board[i] = ai;
        if (checkWin(ai)) { moveIndex = i; board[i] = ""; break; }
        board[i] = "";
      }

      if (moveIndex === undefined) {
        // 2. Check for immediate block
        for (let i of emptyIndices) {
          board[i] = human;
          if (checkWin(human)) { moveIndex = i; board[i] = ""; break; }
          board[i] = "";
        }
      }

      if (moveIndex === undefined) {
        // 3. Center move
        if (board[4] === "") moveIndex = 4;
      }

      if (moveIndex === undefined) {
        // 4. Random corner move
        const corners = [0, 2, 6, 8].filter(i => board[i] === "");
        if (corners.length > 0) moveIndex = corners[Math.floor(Math.random() * corners.length)];
      }

      if (moveIndex === undefined) {
        // 5. Random move
        moveIndex = emptyIndices[Math.floor(Math.random() * emptyIndices.length)];
      }

    } else if (difficulty === 'hard') {
      // Use Minimax
      const bestMove = minimax(board, currentPlayer);
      moveIndex = bestMove.index;
    }

    if (moveIndex !== undefined) {
      makeMove(moveIndex);
    }
  }

  // --- Main Game Flow ---

  // Handle a move on the board
  function makeMove(index) {
    if (!gameActive || board[index] !== "") return false;

    board[index] = currentPlayer;
    updateBoardUI();

    if (checkWin(currentPlayer)) {
      handleGameEnd(currentPlayer);
    } else if (checkDraw()) {
      handleGameEnd(null);
    } else {
      switchPlayer();
      updateStatus(`Player ${currentPlayer}'s turn`);

      if (!isOnline && currentPlayer === 'O') {
        // AI's turn
        setTimeout(aiMove, 500); // Give a slight delay for better UX
      } else if (isOnline) {
        // Online: push move to Firebase
        db.ref('games/' + gameId).update({
          board: board,
          currentPlayer: currentPlayer,
          gameActive: gameActive
        });
      }
    }
    return true;
  }

  // Handle cell click
  function handleCellClick(index) {
    if (isOnline) {
      // Online mode: only allow moves if it's your turn
      if (currentPlayer === playerSymbol) {
        makeMove(index);
      } else {
        updateStatus("Wait for your opponent's move.");
      }
    } else {
      // Single-player mode
      if (currentPlayer === 'X') { // Only human (X) moves on click in single player
        makeMove(index);
      }
    }
  }

  // --- Online Firebase Logic ---

  // Create a new online game
  function createOnlineGame() {
    const newGameRef = db.ref('games').push();
    gameId = newGameRef.key;
    playerSymbol = 'X'; // Creator is always 'X'
    isOnline = true;
    difficultySelect.disabled = true;

    const gameUrl = window.location.href.split('?')[0] + '?gameId=' + gameId;
    gameLink.href = gameUrl;
    gameLink.textContent = gameUrl;
    linkSection.style.display = 'block';

    newGameRef.set({
      board: board,
      currentPlayer: currentPlayer,
      gameActive: gameActive,
      playerX: true, // X has joined
      playerO: false, // O has not joined
    });

    listenToGame(gameId);
    updateStatus(`Waiting for Player O... Share the link!`);
  }

  // Join an existing online game
  function joinOnlineGame(id) {
    gameId = id;
    isOnline = true;
    difficultySelect.disabled = true;

    const gameRef = db.ref('games/' + gameId);
    gameRef.once('value', (snapshot) => {
      const gameData = snapshot.val();
      if (!gameData) {
        updateStatus("Game not found.");
        resetGameLocal();
        return;
      }
      if (gameData.playerO) {
        updateStatus("Game is full or has ended.");
        resetGameLocal();
        return;
      }

      // Assign player 'O'
      playerSymbol = 'O';
      gameRef.update({ playerO: true });
      listenToGame(gameId);
      updateStatus(`Joined as Player O!`);
    });
  }

  // Listen for changes in Firebase
  function listenToGame(id) {
    db.ref('games/' + id).on('value', (snapshot) => {
      const gameData = snapshot.val();
      if (!gameData) return;

      board = gameData.board || ["", "", "", "", "", "", "", "", ""];
      currentPlayer = gameData.currentPlayer || "X";
      gameActive = gameData.gameActive !== undefined ? gameData.gameActive : true;

      updateBoardUI();

      if (!gameData.playerO && playerSymbol === 'X') {
         updateStatus(`Waiting for Player O... Share the link!`);
      } else if (gameActive) {
        if (currentPlayer === playerSymbol) {
          updateStatus(`Your turn (${playerSymbol})`);
        } else {
          updateStatus(`Opponent's turn (${currentPlayer})`);
        }
      } else {
        // Game has ended, check win/draw locally based on received board
        if (checkWin('X')) {
          updateStatus("Player X Wins! ðŸ¥³");
        } else if (checkWin('O')) {
          updateStatus("Player O Wins! ðŸ¥³");
        } else if (checkDraw()) {
          updateStatus("It's a Draw! ðŸ¤");
        }
        db.ref('games/' + id).off(); // Stop listening
      }
    });
  }

  // --- Initialization and Event Handlers ---

  function init() {
    // 1. Get query parameter for online game ID
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('gameId');

    createBoard();

    if (id) {
      modeSelect.value = 'online';
      joinOnlineGame(id);
    } else {
      // Initial local state
      updateStatus(`Player ${currentPlayer}'s turn`);
      difficulty = difficultySelect.value;
    }

    // Event Listeners
    resetBtn.addEventListener('click', () => {
      if (isOnline) {
        // In online mode, ask for confirmation before resetting
        if (confirm('Are you sure you want to quit the current online game?')) {
          resetGameLocal();
        }
      } else {
        resetGameLocal();
      }
    });

    modeSelect.addEventListener('change', (e) => {
      const newMode = e.target.value;
      if (newMode === 'online') {
        createOnlineGame();
      } else {
        resetGameLocal();
      }
    });

    difficultySelect.addEventListener('change', (e) => {
      difficulty = e.target.value;
      if (!isOnline) {
        resetGameLocal();
      }
    });

    muteBtn.addEventListener('click', () => {
      muted = !muted;
      if (muted) {
        bgMusic.pause();
        muteBtn.textContent = 'ðŸ”‡ Unmute';
      } else {
        // Note: Autoplay restrictions often prevent this from working until
        // the user interacts with the page (e.g., clicks the mute button).
        bgMusic.play().catch(e => console.log('Autoplay blocked:', e));
        muteBtn.textContent = 'ðŸ”Š Mute';
      }
    });

    // Attempt to start music on first user interaction (optional)
    document.addEventListener('click', function musicStarter() {
      if (!muted) {
        bgMusic.play().catch(e => console.log('Autoplay blocked:', e));
      }
      document.removeEventListener('click', musicStarter);
    });
  }

  // Start the application
  init();

</script>
</body>
</html>
