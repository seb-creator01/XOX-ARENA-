<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tic Tac Toe by Seb-Creations</title>
  <style>
    body {
      background: linear-gradient(135deg, #7f5af0, #2cb67d);
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      color: white;
      text-align: center;
    }

    h1 {
      margin-top: 20px;
    }

    #controls button {
        /* Base button styles */
      padding: 10px 20px;
      margin: 5px;
      border: none;
      background: #fffffe;
      color: #0f0f0f;
      font-weight: bold;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s, color 0.3s;
    }
    
    #controls button.active {
        /* Style for the currently active mode button */
        background: #7f5af0; 
        color: #fffffe;
        border: 2px solid #2cb67d;
        transform: scale(1.05);
    }

    #game-container {
      /* Flex container to hold multiple boards, if needed. For now, it holds one. */
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px auto;
    }

    #game {
      /* Main game board grid */
      display: grid;
      grid-template-columns: repeat(3, 100px);
      grid-gap: 10px;
    }

    .cell {
      width: 100px;
      height: 100px;
      background: #16161a;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      color: #fffffe;
      border-radius: 10px;
      cursor: pointer;
    }

    .cell.winner {
      background: #2cb67d;
    }

    #scoreboard {
      margin-top: 20px;
    }
    
    #online-scoreboard, #local-scoreboard {
        display: inline-block;
        padding: 10px 20px;
        margin: 0 10px;
        border-radius: 8px;
        background: rgba(0, 0, 0, 0.2);
    }
    
    #online-scoreboard p {
        margin: 5px 0;
    }

    #muteBtn {
      position: absolute;
      top: 10px;
      right: 10px;
    }

    footer {
      margin-top: 40px;
      font-size: 1.1rem; /* Made slightly larger */
      color: #94a1b2;
    }
    
    footer b {
        color: #fffffe; /* Make the developer name stand out */
    }

    #onlineControls {
        margin-top: 15px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
    }
  </style>
</head>
<body>
  <h1>Tic Tac Toe</h1>
  
  <div id="controls">
    <button data-mode="ai_easy" onclick="startGame('ai', 'easy', this)">Play AI (Easy)</button>
    <button data-mode="ai_normal" onclick="startGame('ai', 'normal', this)">Play AI (Normal)</button>
    <button data-mode="ai_hard" onclick="startGame('ai', 'hard', this)">Play AI (Hard)</button>
    <button data-mode="local" onclick="startGame('local', null, this)">Play with Friend (Same Device)</button>
    <button data-mode="online" onclick="handleOnlineStart(this)">Online Multiplayer</button>
    <button id="muteBtn" onclick="toggleMute()">ðŸ”Š</button>
  </div>
  
  <div id="onlineControls" style="display: none;">
      <input type="text" id="roomIdInput" placeholder="Enter Room ID" style="padding: 8px; border-radius: 5px; border: none; margin-right: 5px; color: #0f0f0f;"/>
      <button onclick="createGame()">Create Game (I am X)</button>
      <button onclick="joinGame()">Join Game (I am O)</button>
      <p id="gameStatus" style="font-weight: bold; margin-top: 10px;">Select a mode above.</p>
  </div>

  <div id="scoreboard">
      <div id="local-scoreboard">
          <h3>Local/AI Score</h3>
          <p>Player X: <span id="scoreX">0</span></p>
          <p>Player O: <span id="scoreO">0</span></p>
      </div>
      
      <div id="online-scoreboard" style="display: none;">
          <h3>Online Score</h3>
          <p>You (<span id="localPlayerDisplay">?</span>): <span id="onlineScoreLocal">0</span></p>
          <p>Opponent: <span id="onlineScoreOpponent">0</span></p>
          <p>Draws: <span id="onlineScoreDraws">0</span></p>
      </div>
  </div>

  <div id="game-container">
      <div id="game"></div> 
      </div>

  <footer>Developed by <b>Seb-Creations</b></footer>

  <audio id="bgMusic" loop autoplay>
    <source src="https://www.bensound.com/bensound-music/bensound-sunny.mp3" type="audio/mp3">
  </audio>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // --- UPDATED FIREBASE CONFIGURATION ---
    const firebaseConfig = {
      apiKey: "AIzaSyAFUoT40IjaiqH2791QvyNUP6SakHarupY",
      authDomain: "tic-tac-toe-9e69d.firebaseapp.com",
      projectId: "tic-tac-toe-9e69d",
      storageBucket: "tic-tac-toe-9e69d.appspot.com",
      messagingSenderId: "279666476240",
      appId: "1:279666476240:web:106c4481fbda677424cad5",
      measurementId: "G-WQV8NJN397",
      databaseURL: "https://tic-tac-toe-9e69d-default-rtdb.firebaseio.com"
    };
    // -------------------------------------

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let board = Array(9).fill('');
    let currentPlayer = 'X';
    let isMuted = false;
    let mode = 'local';
    let gameActive = true;
    let aiDifficulty = 'easy';
    let localPlayer = null; 
    let roomId = null;      

    // DOM Elements
    const gameDiv = document.getElementById('game');
    const scoreX = document.getElementById('scoreX');
    const scoreO = document.getElementById('scoreO');
    const bgMusic = document.getElementById('bgMusic');
    const onlineControlsDiv = document.getElementById('onlineControls');
    const roomIdInput = document.getElementById('roomIdInput');
    const gameStatusP = document.getElementById('gameStatus');
    const onlineScoreboardDiv = document.getElementById('online-scoreboard');
    const localScoreboardDiv = document.getElementById('local-scoreboard');
    const localPlayerDisplay = document.getElementById('localPlayerDisplay');
    const onlineScoreLocal = document.getElementById('onlineScoreLocal');
    const onlineScoreOpponent = document.getElementById('onlineScoreOpponent');
    const onlineScoreDraws = document.getElementById('onlineScoreDraws');


    /**
     * Renamed function to drawBoard() as requested.
     * Renders the current state of the board array to the DOM.
     */
    function drawBoard() {
      gameDiv.innerHTML = '';
      board.forEach((val, i) => {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.textContent = val;
        
        // Add win class if present in local state
        const result = checkWinner();
        if (!gameActive && result.winningIndices && result.winningIndices.includes(i)) {
             cell.classList.add('winner');
        }
        cell.onclick = () => handleClick(i);
        gameDiv.appendChild(cell);
      });
      
      // Update status for online play
      if (mode === 'online' && localPlayer) {
          const result = checkWinner();
          if (!gameActive) {
             gameStatusP.textContent = `Game Over! ${result.winner === 'Draw' ? 'It\'s a Draw!' : `${result.winner} wins!`}`;
          } else {
             gameStatusP.textContent = `You are ${localPlayer}. It is ${currentPlayer}'s turn.`;
          }
      } else if (mode === 'online') {
          gameStatusP.textContent = 'Waiting to create or join a game...';
      }
    }

    function handleClick(index) {
      if (!gameActive || board[index]) return;
      
      if (mode === 'online') {
          if (currentPlayer !== localPlayer) {
              gameStatusP.textContent = `It is not your turn (${currentPlayer}'s turn).`;
              return; 
          }
          handleOnlineMove(index);
      } else {
          board[index] = currentPlayer;
          drawBoard();
          checkWinner();
          currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
          if (mode === 'ai') aiMove();
      }
    }

    function checkWinner() {
      const wins = [
        [0,1,2], [3,4,5], [6,7,8], // Rows
        [0,3,6], [1,4,7], [2,5,8], // Columns
        [0,4,8], [2,4,6]           // Diagonals
      ];
      
      let winner = null;
      let winningIndices = null;

      for (let [a,b,c] of wins) {
        if (board[a] && board[a] === board[b] && board[a] === board[c]) {
          winner = board[a];
          winningIndices = [a,b,c];
          gameActive = false;
          
          if (mode !== 'online') {
             // Local/AI Mode: Apply win visuals and reset game
             updateLocalScore(winner);
             setTimeout(resetGame, 2000);
          }
          return { winner, winningIndices };
        }
      }

      if (!board.includes('')) {
        gameActive = false;
        if (mode !== 'online') {
           setTimeout(resetGame, 2000);
        }
        return { winner: 'Draw' };
      }
      
      return {}; 
    }
    
    // --- Score Management ---
    
    function updateLocalScore(winner) {
      if (winner === 'X') scoreX.textContent = +scoreX.textContent + 1;
      else if (winner === 'O') scoreO.textContent = +scoreO.textContent + 1;
    }
    
    function updateOnlineScoreboard(scores) {
        const localWinCount = localPlayer === 'X' ? scores.scoreX : scores.scoreO;
        const opponentWinCount = localPlayer === 'X' ? scores.scoreO : scores.scoreX;
        
        onlineScoreLocal.textContent = localWinCount;
        onlineScoreOpponent.textContent = opponentWinCount;
        onlineScoreDraws.textContent = scores.draws;
        localPlayerDisplay.textContent = localPlayer;
    }
    
    // --- Game Flow and Mode Switching ---

    function resetGame() {
      board = Array(9).fill('');
      currentPlayer = 'X';
      gameActive = true;
      drawBoard();
    }

    function setActiveButton(activeButton) {
        document.querySelectorAll('#controls button').forEach(btn => {
            btn.classList.remove('active');
        });
        if (activeButton) {
            activeButton.classList.add('active');
        }
    }

    function startGame(selectedMode, difficulty, button) {
      mode = selectedMode;
      setActiveButton(button);
      onlineControlsDiv.style.display = 'none';
      onlineScoreboardDiv.style.display = 'none';
      localScoreboardDiv.style.display = 'inline-block';
      localPlayer = null; 
      roomId = null;      
      
      // Clear previous Firebase listener
      if (db.ref('games/' + roomId)) db.ref('games/' + roomId).off(); 
      
      resetGame();
      if (mode === 'ai') aiDifficulty = difficulty;
      gameStatusP.textContent = 'Game started locally or vs AI.';
    }
    
    function handleOnlineStart(button) {
        mode = 'online';
        setActiveButton(button);
        onlineControlsDiv.style.display = 'block';
        onlineScoreboardDiv.style.display = 'inline-block';
        localScoreboardDiv.style.display = 'none';
        gameStatusP.textContent = 'Enter a room ID or generate one.';
    }

    // --- Online Multiplayer Functions (Modified for Scoreboard) ---

    function generateRoomId() {
        return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    function createGame() {
        roomId = roomIdInput.value.trim() || generateRoomId();
        localPlayer = 'X';
        
        // Initialize game state with score
        db.ref('games/' + roomId).set({
            board: Array(9).fill(''),
            currentPlayer: 'X',
            gameActive: true,
            playerX: true, 
            playerO: false, 
            scores: { scoreX: 0, scoreO: 0, draws: 0 } // Initialize scores
        }).then(() => {
            gameStatusP.textContent = `Game created! Your ID is: ${roomId}. Waiting for Player O...`;
            roomIdInput.value = roomId;
            syncGame();
        });
    }

    function joinGame() {
        roomId = roomIdInput.value.trim();
        if (!roomId) {
            gameStatusP.textContent = "Please enter a Room ID.";
            return;
        }
        
        db.ref('games/' + roomId).once('value', snapshot => {
            const gameState = snapshot.val();
            if (snapshot.exists() && !gameState.playerO) {
                localPlayer = 'O';
                db.ref('games/' + roomId + '/playerO').set(true)
                  .then(() => {
                    gameStatusP.textContent = `Joined game ${roomId}! You are O. X goes first.`;
                    syncGame();
                  });
            } else if (snapshot.exists() && gameState.playerO) {
                gameStatusP.textContent = "Room is full.";
            } else {
                gameStatusP.textContent = "Room does not exist.";
            }
        });
    }

    function syncGame() {
        db.ref('games/' + roomId).on('value', snapshot => {
            if (!snapshot.exists()) return;

            const gameState = snapshot.val();
            
            // Update local state from Firebase
            board = gameState.board;
            currentPlayer = gameState.currentPlayer;
            gameActive = gameState.gameActive;
            
            // Update Online Scoreboard
            if (gameState.scores) {
               updateOnlineScoreboard(gameState.scores);
            }

            drawBoard();

            // Handle win/draw condition received from opponent
            if (!gameActive) {
                const result = checkWinner();
                
                if (localPlayer === 'X') { // Only Player X handles the scoring and reset confirmation
                    setTimeout(() => {
                        if (confirm(`Game over. ${result.winner === 'Draw' ? 'It was a Draw.' : `${result.winner} wins!`}\n\nStart a new round?`)) {
                           // Update scores in Firebase
                           let newScores = gameState.scores || { scoreX: 0, scoreO: 0, draws: 0 };
                           if (result.winner === 'X') newScores.scoreX++;
                           else if (result.winner === 'O') newScores.scoreO++;
                           else if (result.winner === 'Draw') newScores.draws++;
                           
                           db.ref('games/' + roomId).update({
                               board: Array(9).fill(''),
                               currentPlayer: 'X',
                               gameActive: true,
                               scores: newScores // Push updated scores
                           });
                       } else {
                           db.ref('games/' + roomId).off();
                           gameStatusP.textContent = `Game disconnected. Scores: X-${gameState.scores.scoreX}, O-${gameState.scores.scoreO}, Draws-${gameState.scores.draws}`;
                       }
                    }, 3000);
                }
            }
        });
    }

    function handleOnlineMove(index) {
        board[index] = localPlayer;
        
        const result = checkWinner(); 
        const nextPlayer = localPlayer === 'X' ? 'O' : 'X';
        
        db.ref('games/' + roomId).update({
            board: board,
            currentPlayer: result.winner || result.winner === 'Draw' ? localPlayer : nextPlayer,
            gameActive: result.winner || result.winner === 'Draw' ? false : true
        });
    }
    
    // --- AI Logic (Still Random, ready for Minimax implementation) ---

    function aiMove() {
      if (!gameActive || currentPlayer !== 'O') return;
      
      let empty = board.map((v, i) => v === '' ? i : null).filter(v => v !== null);
      
      if (empty.length > 0) {
        let move = empty[Math.floor(Math.random() * empty.length)];
        board[move] = 'O';
        drawBoard();
        checkWinner();
        currentPlayer = 'X';
      }
    }

    function toggleMute() {
      isMuted = !isMuted;
      bgMusic.muted = isMuted;
      document.getElementById('muteBtn').textContent = isMuted ? 'ðŸ”‡' : 'ðŸ”Š';
    }

    drawBoard();
  </script>
</body>
</html>
